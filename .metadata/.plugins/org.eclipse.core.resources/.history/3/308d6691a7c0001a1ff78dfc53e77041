import java.net.URI;
import java.net.http.*;
import java.net.http.HttpResponse.BodyHandlers;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Iterator;
import java.util.List;

import org.json.*;

public class dp {

	public static void main(String[] args) throws Exception {
		httprequester();
		// TODO Auto-generated method stub

	}	
	public static ArrayList<List<Object>> httprequester() throws Exception {
		HttpClient cp = HttpClient.newHttpClient();
		HttpRequest r = HttpRequest.newBuilder().uri(URI.create("https://covidtracking.com/api/us/daily")).build();
		HttpResponse<String> response = cp.send(r, BodyHandlers.ofString());
//		System.out.println(response.body());
		return JSONparser2(response.body());
	}

	private static void JSONparser(String response)  throws Exception {

		JSONArray array = new JSONArray(response);

		for (int i = 0; i<array.length(); i++) {
			JSONObject object = array.getJSONObject(i);
			Iterator<String> keys = object.keys();
			while (keys.hasNext()) {
				String key = (String) keys.next();
				String value = object.get(key).toString();
				System.out.println(key + ": " + value);
			}
		}
	}

	public static ArrayList<List<Object>> JSONparser2(String response)  throws Exception {

		JSONArray array = new JSONArray(response);
		ArrayList<List<Object>> listOfLists = new ArrayList<List<Object>>();
		for (int i = 0; i<array.length(); i++) {
			JSONObject object = array.getJSONObject(i);
//			System.out.println("Processing " + object.get("date"));
//			// Thread.sleep(4000);
			if (i==0) {
//				System.out.println("Making list of keys");
				ArrayList<Object> headerRowList = makeListOfKeys(object);
				addMyKeys(headerRowList);
				listOfLists.add(headerRowList);
			}
			Iterator<String> keys = object.keys();
			ArrayList<Object> valuesList = new ArrayList<Object>();
			while (keys.hasNext()) {
				String key = (String) keys.next();
				String value = object.get(key).toString();

//				if (key.equalsIgnoreCase("date")) {
//					System.out.println("Adding " + object.get(key));
//				}
				valuesList.add(value);
			}
			addMyValues(valuesList);
			fixDates(valuesList);

			// why didn't sublist work?
			// List<String> topValues = valuesList.subList(0, 25);
			listOfLists.add(valuesList);

		}
//		for(int j = 0; j<listOfLists.size(); j++) {
//			for(int k = 0; k<listOfLists.get(j).size(); k++) {
//				System.out.print(listOfLists.get(j).get(k) + ", ");
//			}
//			System.out.println();
//			Thread.sleep(4000);
//		}
		get7DayAverage(listOfLists);
		return listOfLists;

	}
	
	public static ArrayList<Object> addMyKeys(ArrayList<Object> autoKeys) {
		autoKeys.add(25, "7-day death average");
		autoKeys.add(26, "Daily percent positive");
		autoKeys.add(27, "Total percent positive");
		return autoKeys;
		
	}
	
	public static ArrayList<Object> addMyValues(ArrayList<Object> autoValues) {
		autoValues.add(25, "Do this manually");
		String DailyPercentPositive;
		double dailyPositive = Integer.parseInt(autoValues.get(14).toString());
		double dailyTests = Integer.parseInt(autoValues.get(2).toString());
		System.out.println(dailyTests);
		System.out.println(dailyPositive);
		if (dailyTests != 0) {
			DailyPercentPositive = String.valueOf(dailyPositive/dailyTests*100) + "%";
			autoValues.add(26, DailyPercentPositive);
			System.out.println(DailyPercentPositive);
		}
		else {
			autoValues.add(26, "0");
		}
		String TotalPercentPositive;
		double TotalPositive = Integer.parseInt(autoValues.get(20).toString());
		double TotalTests = Integer.parseInt(autoValues.get(21).toString());
		if (TotalTests != 0) {
			TotalPercentPositive = String.valueOf(TotalPositive/TotalTests*100) + "%";
			autoValues.add(27, TotalPercentPositive);
			
		}
		else {
			autoValues.add(27, "0");
		}
		return autoValues;
	}
	
	public static ArrayList<List<Object>> get7DayAverage(ArrayList<List<Object>> originalList) {
		
		for (int i = 1; i<originalList.size(); i++) {
			int weekTotal = 0;
			for (int j = 1; j<8; j++) {
				weekTotal += Integer.parseInt(originalList.get(i).get(15).toString());
			}
			System.out.println("Seven day average: " + weekTotal/7);
		}
		return originalList;
	}
	
	public static ArrayList<Object> fixDates(ArrayList<Object> normalDates) {
		String originalDate = normalDates.get(0).toString();
		String newDate;
		newDate = originalDate.charAt(4) +""+ originalDate.charAt(5) + "/" + originalDate.charAt(6) + originalDate.charAt(7)+ "/" + "2020";
		normalDates.set(0, newDate);
		System.out.println("Date: " + newDate);
		return normalDates;
	}

	private static ArrayList<Object> makeListOfKeys(JSONObject object) throws Exception {
		// What exactly is an iterator?
		Iterator<String> keys = object.keys();
		ArrayList<Object> listOfKeys = new ArrayList<Object> ();

		while(keys.hasNext()) {
			listOfKeys.add(keys.next());
		}

		return listOfKeys;
	}



}
